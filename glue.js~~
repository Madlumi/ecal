
// =====================
// LANGUAGE DETECTION & HELPERS
// =====================
// Immediately read “lang” from URL. Default to “sv”. If invalid, fallback to “sv”.
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  let lang = urlParams.get("lang") || "sv";
  if (!["sv","en","fi"].includes(lang)) {
    lang = "sv";
  }
  window.SELECTED_LANG = lang;
})();

// Returns STRINGS[key][selectedLanguage], with fallbacks: chosen → “sv” → "[no string found]"
function getString(key) {
  if (!STRINGS.hasOwnProperty(key)) {
    return "[no string found]";
  }
  const entry = STRINGS[key];
  // If the author accidentally provided a plain string instead of an object:
  if (typeof entry === "string") {
    return entry;
  }
  // 1) If chosen language exists and non­empty, return that
  if (entry.hasOwnProperty(window.SELECTED_LANG) && entry[window.SELECTED_LANG]) {
    return entry[window.SELECTED_LANG];
  }
  // 2) Fallback to Swedish
  if (entry.hasOwnProperty("sv") && entry["sv"]) {
    return entry["sv"];
  }
  // 3) If even Swedish is missing, show placeholder
  return "[no string found]";
}

// =====================
// LOCKED_COMBINATIONS
// (An array you can use to disable certain measure/source combinations.)
// Example: disallow “Fjärrkyla” in “Värme.”
//
// EType.FJARRKYLA is the enum index for “Fjärrkyla.”
// EType.XXX are indices 0..5 in your energy.js file.
// =====================
const LOCKED_COMBINATIONS = [
  // { measureKey: "heat", sourceIndex: EType.FJARRKYLA },
  // { measureKey: "heat", sourceIndex: EType.BIOBRANSLE },
  // … etc.
  // You can iterate over this array and disable (or hide) the corresponding <input> fields.
];

// =====================
// APPLY STRINGS TO DOM & INITIAL SETUP
// =====================
function applyStrings() {
  // 1) Language Selector (no need to translate flags, but we can highlight the current)
  document.querySelectorAll(".lang-button").forEach(btn => {
    btn.style.opacity = (btn.dataset.lang === window.SELECTED_LANG) ? "1" : "0.5";
  });

  // 2) Disclaimer
  const discBox = document.getElementById("disclaimerBox");
  const discText = getString("disclaimer");
  if (discText) {
    discBox.textContent = discText;
    discBox.style.display = "block";
  } else {
    discBox.style.display = "none";
  }

  // 3) Application Title
  document.getElementById("appTitle").innerHTML = getString("app_title");

  // 4) Geography
  document.getElementById("geographyLabel").textContent = getString("geography_label");
  const geoIcon = document.getElementById("geoInfo");
  const geoHelpText = getString("geography_help");
  if (geoHelpText) {
    geoIcon.textContent = getString("info_icon");
    geoIcon.title = geoHelpText;
    document.getElementById("geoHelp").textContent = geoHelpText;
    geoIcon.addEventListener("click", () => {
      const box = document.getElementById("geoHelp");
      box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    geoIcon.style.display = "none";
  }

  // 5) House Type
  document.getElementById("housetypeLabel").textContent = getString("housetype_label");
  const typeIcon = document.getElementById("typeInfo");
  const typeHelpText = getString("housetype_help");
  if (typeHelpText) {
    typeIcon.textContent = getString("info_icon");
    typeIcon.title = typeHelpText;
    document.getElementById("typeHelp").textContent = typeHelpText;
    typeIcon.addEventListener("click", () => {
      const box = document.getElementById("typeHelp");
      box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    typeIcon.style.display = "none";
  }

  // 6) Footnotes heading + labels
  document.getElementById("lbl_footnotes_heading").textContent = getString("footnotes_heading");

  // Footnote 4
  document.getElementById("foot4Label").textContent = getString("foot4_label");
  const f4Icon = document.getElementById("foot4Info");
  const f4HelpText = getString("foot4_help");
  if (f4HelpText) {
    f4Icon.textContent = getString("info_icon");
    f4Icon.title = f4HelpText;
    document.getElementById("foot4Help").textContent = f4HelpText;
    f4Icon.addEventListener("click", () => {
      const box = document.getElementById("foot4Help");
      box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    f4Icon.style.display = "none";
  }

  // Footnote 5
  document.getElementById("foot5Label").textContent = getString("foot5_label");
  const f5Icon = document.getElementById("foot5Info");
  const f5HelpText = getString("foot5_help");
  if (f5HelpText) {
    f5Icon.textContent = getString("info_icon");
    f5Icon.title = f5HelpText;
    document.getElementById("foot5Help").textContent = f5HelpText;
    f5Icon.addEventListener("click", () => {
      const box = document.getElementById("foot5Help");
      box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    f5Icon.style.display = "none";
  }

  // 7) Flow (q)
  document.getElementById("flowLabel").textContent = getString("flow_label");
  const flowIcon = document.getElementById("flowInfo");
  const flowHelpText = getString("flow_help");
  if (flowHelpText) {
    flowIcon.textContent = getString("info_icon");
    flowIcon.title = flowHelpText;
    flowIcon.addEventListener("click", () => {
      const box = document.getElementById("flowHelp");
      if (box) box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    flowIcon.style.display = "none";
  }

  // 8) Atemp
  document.getElementById("atempLabel").textContent = getString("atemp_label");
  const aIcon = document.getElementById("atempInfo");
  const aHelpText = getString("atemp_help");
  if (aHelpText) {
    aIcon.textContent = getString("info_icon");
    aIcon.title = aHelpText;
    document.getElementById("atempHelp").textContent = aHelpText;
    aIcon.addEventListener("click", () => {
      const box = document.getElementById("atempHelp");
      box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    aIcon.style.display = "none";
  }

  // 9) “Energyfaktorer:” label
  document.getElementById("energyTableLabel").textContent = getString("energy_table_label");

  // 10) Permalänk
  document.getElementById("permalinkLabel").textContent = getString("permalink_label");
  const pIcon = document.getElementById("permalinkInfo");
  const pHelpText = getString("permalink_help");
  if (pHelpText) {
    pIcon.textContent = getString("info_icon");
    pIcon.title = pHelpText;
    document.getElementById("permalinkHelp").textContent = pHelpText;
    pIcon.addEventListener("click", () => {
      const box = document.getElementById("permalinkHelp");
      box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    pIcon.style.display = "none";
  }

  // 11) Clear & Copy buttons
  document.getElementById("clearBtn").textContent = getString("clear_button");
  document.getElementById("copyBtn").textContent  = getString("copy_button");

  // 12) EPpet + limits
  const printedEPEl = document.getElementById("printedEP");
  printedEPEl.innerHTML = getString("ep_label");
  const epIcon = document.getElementById("epInfo");
  const epHelpText = getString("ep_help");
  if (epHelpText) {
    epIcon.textContent = getString("info_icon");
    epIcon.title = epHelpText;
    document.getElementById("epHelp").textContent = epHelpText;
    epIcon.addEventListener("click", () => {
      const box = document.getElementById("epHelp");
      box.style.display = box.style.display === "block" ? "none" : "block";
    });
  } else {
    epIcon.style.display = "none";
  }
}

// =====================
// DYNAMIC TABLE CREATION
// =====================
function getTableoptions() {
  const geoSelect = document.getElementById("geography");
  if (!geoSelect) return;
  geoSelect.innerHTML = "";
  locations.forEach((loc) => {
    const opt = document.createElement("option");
    opt.value = loc.name;
    opt.textContent = loc.name;
    geoSelect.appendChild(opt);
  });
}

function getEnergyTable() {
  const table = document.getElementById("energyTable");
  if (!table) return;
  table.innerHTML = "";

  // 1) Header row
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  const cornerTh = document.createElement("th");
  cornerTh.textContent = ""; // blank corner cell
  headerRow.appendChild(cornerTh);

  // Column headers from energy.js → E_name[]
  for (let i = 0; i < EType.E_TYPE_COUNT; i++) {
    const th = document.createElement("th");
    th.textContent = E_name[i];
    headerRow.appendChild(th);
  }
  thead.appendChild(headerRow);
  table.appendChild(thead);

  // 2) Body rows
  const tbody = document.createElement("tbody");
  const measures = [
    { key: "heat",  labelKey: "energy_row_heat", helpKey: "energy_row_heat_help" },
    { key: "cool",  labelKey: "energy_row_cool", helpKey: "energy_row_cool_help" },
    { key: "watr",  labelKey: "energy_row_watr", helpKey: "energy_row_watr_help" },
    { key: "fast",  labelKey: "energy_row_fast", helpKey: "energy_row_fast_help" }
  ];

  window.heatEls = {};
  window.coolEls = {};
  window.watrEls = {};
  window.fastEls = {};

  measures.forEach((meas) => {
    const tr = document.createElement("tr");

    // Label cell + optional “?” icon if help exists
    const labelTd = document.createElement("td");
    labelTd.textContent = getString(meas.labelKey);
    const rowHelpText = getString(meas.helpKey);
    if (rowHelpText && rowHelpText !== "[no string found]") {
      const icon = document.createElement("span");
      icon.className = "info-icon";
      icon.textContent = getString("info_icon");
      icon.title = rowHelpText;
      icon.addEventListener("click", () => {
        alert(rowHelpText);
      });
      labelTd.appendChild(icon);
    }
    tr.appendChild(labelTd);

    // One <input> per energy source
    for (let i = 0; i < EType.E_TYPE_COUNT; i++) {
      const td = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.step = "any";
      const sourceKey = E_name[i].toLowerCase().replace(/\s+/g, "_");
      input.id   = `${meas.key}-${sourceKey}`;
      input.name = input.id;
      td.appendChild(input);
      tr.appendChild(td);

      if (meas.key === "heat")  window.heatEls[i] = input;
      if (meas.key === "cool")  window.coolEls[i] = input;
      if (meas.key === "watr")  window.watrEls[i] = input;
      if (meas.key === "fast")  window.fastEls[i] = input;
    }

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
}

// =====================
// MAIN LOGIC & EVENT BINDING
// =====================
document.addEventListener("DOMContentLoaded", () => {
  // 1) Apply all strings
  applyStrings();

  // 2) Build geography dropdown + energy table
  getTableoptions();
  getEnergyTable();

  // 3) Grab references to dynamic elements
  const houseTypeEl   = document.getElementById("housetype");
  const footnoteBox   = document.getElementById("footnoteBox");
  const foot4El       = document.getElementById("foot4");
  const foot5El       = document.getElementById("foot5");
  const flowEl        = document.getElementById("flow");

  const geoHelpBox    = document.getElementById("geoHelp");
  const typeHelpBox   = document.getElementById("typeHelp");
  const foot4HelpBox  = document.getElementById("foot4Help");
  const foot5HelpBox  = document.getElementById("foot5Help");
  const atempHelpBox  = document.getElementById("atempHelp");
  const permalinkHelpBox = document.getElementById("permalinkHelp");
  const epHelpBox     = document.getElementById("epHelp");

  // 4) Show/hide footnotes when housetype changes
  houseTypeEl.addEventListener("change", () => {
    if (houseTypeEl.value === "MULTI") {
      footnoteBox.style.display = "block";
    } else {
      footnoteBox.style.display = "none";
      foot4El.checked = false;
      foot5El.checked = false;
      flowEl.value = "";
      if (foot4HelpBox)  foot4HelpBox.style.display  = "none";
      if (foot5HelpBox)  foot5HelpBox.style.display  = "none";
    }
  });

  // 5) Other form references
  const geographyEl   = document.getElementById("geography");
  const atempEl       = document.getElementById("atemp");
  const permalinkEl   = document.getElementById("permalink");
  const printedEPEl   = document.getElementById("printedEP");
  const limitsTableEl = document.getElementById("limitsTable");
  const clearBtn      = document.getElementById("clearBtn");
  const copyBtn       = document.getElementById("copyBtn");
  const formEl        = document.getElementById("houseForm");

  // 6) Main calculate() function
  function calculate() {
    const locName = geographyEl.value;
    const locationObj = locations.find(loc => loc.name === locName);

    const typeStr = houseTypeEl.value;
    const typeNum = HouseType[typeStr];

    const atemp = parseInt(atempEl.value, 10) || 0;
    let flowVal = parseFloat(flowEl.value) || 0;
    const qavg   = parseFloat(flowEl.value) || 0;

    const f4 = foot4El.checked;
    const f5 = foot5El.checked;

    const h = new House(typeNum, atemp, locationObj);
    h.flow   = flowVal;
    h.qavg   = qavg;
    h.foot4  = f4;
    h.foot5  = f5;

    for (let i = 0; i < EType.E_TYPE_COUNT; i++) {
      h.E.heat[i] = parseFloat(heatEls[i].value) || 0;
      h.E.cool[i] = parseFloat(coolEls[i].value) || 0;
      h.E.watr[i] = parseFloat(watrEls[i].value) || 0;
      h.E.fast[i] = parseFloat(fastEls[i].value) || 0;
    }

    // 7) Compute EPpet and limits
    const ep = EPpet(h);
    const lim = limit(h);

    // 8) Display EPpet, with warning if above limit
    if (ep > lim.EP) {
      printedEPEl.innerHTML = `${getString("ep_label")} ${ep} <span class="warning-icon" title="${getString("warning_tooltip")}">⚠</span>`;
    } else {
      printedEPEl.innerHTML = `${getString("ep_label")} ${ep}`;
    }

    // 9) Populate Limits table, replacing -1 with blank and 9999 with “Inget krav”
    let llDisplay = "";
    if (lim.LL === -1) {
      llDisplay = "";
    } else {
      llDisplay = lim.LL.toFixed(2);
    }
    let epLimitDisp = (lim.EP === 9999) ? getString("no_requirement") : lim.EP.toFixed(1);
    let elLimitDisp = (lim.EL === 9999) ? getString("no_requirement") : lim.EL.toFixed(1);

    limitsTableEl.innerHTML = `
      <tr><th>${getString("limit_ep")}</th><td>${epLimitDisp}</td></tr>
      <tr><th>${getString("limit_el")}</th><td>${elLimitDisp}</td></tr>
      <tr><th>${getString("limit_um")}</th><td>${lim.UM.toFixed(2)}</td></tr>
      <tr><th>${getString("limit_ll")}</th><td>${llDisplay}</td></tr>
    `;

    // 10) Build Permalink (do NOT include ?lang= here—it’s up to user to add manually)
    const params = new URLSearchParams();
    params.set("geography", locName);
    params.set("housetype", typeStr);
    params.set("atemp", atemp);
    if (!isNaN(flowVal)) params.set("flow", flowVal);
    if (f4) params.set("foot4", "1");
    if (f5) params.set("foot5", "1");
    for (let i = 0; i < EType.E_TYPE_COUNT; i++) {
      if (h.E.heat[i] !== 0)  params.set(`heat${i}`,  h.E.heat[i]);
      if (h.E.cool[i] !== 0)  params.set(`cool${i}`,  h.E.cool[i]);
      if (h.E.watr[i] !== 0)  params.set(`watr${i}`,  h.E.watr[i]);
      if (h.E.fast[i] !== 0)  params.set(`fast${i}`,  h.E.fast[i]);
    }
    // We do NOT append “lang=” here—if the user wants the English (or Finnish) version, they must add &lang=en or &lang=fi themselves.
    const base = window.location.pathname + "?" + params.toString();
    permalinkEl.value = base;
  }

  // 11) Auto-calculate whenever any input changes
  formEl.addEventListener("input", calculate);

  // 12) Pre-populate form fields from URL on load
  const qs = new URLSearchParams(window.location.search);
  if (qs.has("geography")) {
    geographyEl.value = qs.get("geography");
  }
  if (qs.has("housetype")) {
    houseTypeEl.value = qs.get("housetype");
    houseTypeEl.dispatchEvent(new Event("change"));
  }
  if (qs.has("atemp")) {
    atempEl.value = qs.get("atemp");
  }
  if (qs.has("flow")) {
    flowEl.value = qs.get("flow");
  }
  if (qs.has("foot4")) {
    foot4El.checked = qs.get("foot4") === "1";
  }
  if (qs.has("foot5")) {
    foot5El.checked = qs.get("foot5") === "1";
  }
  for (let i = 0; i < EType.E_TYPE_COUNT; i++) {
    if (qs.has(`heat${i}`)) {
      heatEls[i].value = qs.get(`heat${i}`);
    }
    if (qs.has(`cool${i}`)) {
      coolEls[i].value = qs.get(`cool${i}`);
    }
    if (qs.has(`watr${i}`)) {
      watrEls[i].value = qs.get(`watr${i}`);
    }
    if (qs.has(`fast${i}`)) {
      fastEls[i].value = qs.get(`fast${i}`);
    }
  }
  if ([...qs.keys()].length > 0) {
    calculate();
  }

  // 13) Clear button resets form + results
  clearBtn.addEventListener("click", () => {
    formEl.reset();
    footnoteBox.style.display    = "none";
    geoHelpBox.style.display     = "none";
    typeHelpBox.style.display    = "none";
    if (foot4HelpBox)  foot4HelpBox.style.display   = "none";
    if (foot5HelpBox)  foot5HelpBox.style.display   = "none";
    if (atempHelpBox)  atempHelpBox.style.display   = "none";
    if (permalinkHelpBox) permalinkHelpBox.style.display = "none";
    if (epHelpBox)    epHelpBox.style.display       = "none";
    document.getElementById("energyTable").querySelectorAll("input").forEach(inp => inp.value = "");
    printedEPEl.textContent = "";
    limitsTableEl.innerHTML = "";
    permalinkEl.value = "";
    window.history.replaceState(null, "", window.location.pathname);
  });

  // 14) Copy button: copy permalink to clipboard
  copyBtn.addEventListener("click", () => {
    permalinkEl.select();
    permalinkEl.setSelectionRange(0, Infinity);
    try {
      document.execCommand("copy");
      copyBtn.textContent = getString("copy_button") + " ✔";
      setTimeout(() => {
        copyBtn.textContent = getString("copy_button");
      }, 1500);
    } catch (err) {
      alert("Could not copy to clipboard");
    }
  });

  // 15) Language switcher buttons
  document.querySelectorAll(".lang-button").forEach(btn => {
    btn.addEventListener("click", () => {
      // Build a new URL that retains all existing query params except "lang",
      // then append &lang=selectedLang, and reload the page.
      const currentParams = new URLSearchParams(window.location.search);
      currentParams.set("lang", btn.dataset.lang);
      const newUrl = window.location.pathname + "?" + currentParams.toString();
      window.location.href = newUrl;
    });
  });
});
